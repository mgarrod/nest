<html>
<head>

<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dijit/themes/nihilo/nihilo.css">
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.16.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dojo/dojo.js"
            data-dojo-config="async: true,parseOnLoad: true"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/xrange.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>

<script type="text/javascript">
AWS.config.update({
  region: "us-east-1",
  // The endpoint should point to the local or remote computer where DynamoDB (downloadable) is running.
  //endpoint: 'http://localhost:8000',
  /*
    accessKeyId and secretAccessKey defaults can be used while using the downloadable version of DynamoDB. 
    For security reasons, do not store AWS Credentials in your files. Use Amazon Cognito instead.
  */
  //accessKeyId: "fakeMyKeyId",
  //secretAccessKey: "fakeSecretAccessKey"
  credentials: new AWS.CognitoIdentityCredentials({
        IdentityPoolId: ""
    })
});

  /* 
     Uncomment the following code to configure Amazon Cognito and make sure to 
     remove the endpoint, accessKeyId and secretAccessKey specified in the code above. 
     Make sure Cognito is available in the DynamoDB web service region (specified above).
     Finally, modify the IdentityPoolId and the RoleArn with your own.
  */
/*
AWS.config.credentials = new AWS.CognitoIdentityCredentials({
IdentityPoolId: "us-west-2:12345678-1ab2-123a-1234-a12345ab12",
RoleArn: "arn:aws:iam::123456789012:role/dynamocognito"
});
*/

var dynamodb = new AWS.DynamoDB();
var docClient = new AWS.DynamoDB.DocumentClient();

var tableName = "nest_thermostat";

var devices = [
    { label: "Dining Room", value: "15AA01AC30170FLK" }
];
var deviceSelect = null;

var deviceData = [];
var dataDays = [];
var dataHeat = [];
var dataCool = [];

var tempMin = null;
var tempMax = null;

require([
    "dojo/dom",
    "dojo/dom-construct",
    "dojo/_base/lang",
    "dijit/registry",
    "dojo/date/locale",
    "dijit/form/Select",
    "dijit/form/DateTextBox",
    "dijit/form/CheckBox",
    "dojo/number",
    "dojo/request",
    "dojo/promise/all",
    "dojo/Deferred",
    "dijit/form/Button",
    "dojo/domReady!"
], function (dom, domConstruct, lang, registry, locale, Select, DateTextBox, CheckBox, number, request, all, Deferred, Button) {
    
    deviceSelect = new Select({
        name: "deviceSelect",
        options: devices
    });
    deviceSelect.on("change", function(){
      buildMainChart();
    });
    deviceSelect.placeAt(dom.byId("devices")).startup();

    var date = new Date();
    date.setDate(date.getDate() - 8);
    var beginningOfTime = locale.format( date, {selector:"date", datePattern:"y-M-d" } );
    startDate = new DateTextBox({
        value: beginningOfTime
    });
    startDate.on("change", function(){
      buildMainChart();
    });
    startDate.placeAt(dom.byId("startDate")).startup();

    date = new Date();
    date.setDate(date.getDate() - 1);
    var endOfTime = locale.format( date, {selector:"date", datePattern:"y-M-d" } );
    endDate = new DateTextBox({
        value: endOfTime
    });
    endDate.on("change", function(){
      buildMainChart();
    });
    endDate.placeAt(dom.byId("endDate")).startup();

    var checkBox = new CheckBox({
        name: "showWeather",
        checked: false
    });
    checkBox.on("change", function(value){
        buildMainChart();
    });
    checkBox.placeAt(dom.byId("showWeather")).startup();

    function buildMainChart() {

        all([queryData(), getWeather()]).then(function(){

            var series = [{
                type: 'area',
                yAxis: 0,
                name: 'Heat',
                data: dataHeat,
                color: '#f7a35c'
            }, {
                type: 'area',
                yAxis: 0,
                name: 'Cool',
                data: dataCool
            }];

            if (checkBox.get("value") && tempMin != null && tempMax != null) {
                series.push(tempMax);
                series.push(tempMin);
            }

            Highcharts.chart('container', {
                // chart: {
                //     type: 'area'
                // },
                title: {
                    text: 'Nest History for ' + deviceSelect.get("displayedValue")
                },
                xAxis: {
                    categories: dataDays,
                    crosshair: true,
                    allowDecimals: false,
                    labels: {
                        formatter: function () {
                            return this.value; // clean, unformatted number for day
                        }
                    }
                },
                yAxis: [{
                    title: {
                        text: 'Total Time Running'
                    },
                    labels: {
                        formatter: function () {
                            return number.format(this.value / 60 / 60 , { places: 1 }) + ' hours'
                        }
                    }
                },
                {
                    title: {
                        text: 'Outside Temperature'
                    },
                    labels: {
                        formatter: function () {
                            return this.value + '° F'
                        }
                    },
                    opposite: true
                }],
                tooltip: {
                    shared: true,
                    pointFormatter: function () {
                        if (this.series.name == 'Heat' || this.series.name == 'Cool') {
                            return 'The ' + this.series.name + ' ran for <b>' + number.format(this.y / 60 / 60 , { places: 1 }) + '</b> hours (click for cycles)<br />'
                        }
                        else if (this.series.name == 'Minimum Tempature' || this.series.name == 'Maximum Tempature') {
                            return 'The ' + this.series.name + ' was <b>' + this.y + '</b>° F<br />'
                        }
                    }
                },
                plotOptions: {
                    series: {
                        cursor: 'pointer',
                        point: {
                            events: {
                                click: function () {
                                    //if (this.series.name == 'Heat' || this.series.name == 'Cool') {
                                        showDetails(this.x);
                                    //}
                                }
                            }
                        }
                    }
                },
                series: series
            });
        });
    }

    function showDetails(index) {
        //console.log(deviceData[index]);
        var device = deviceData[index];

        var d = new Date(device.day);
        //d.setSeconds(d.getSeconds() + Math.abs(device.device_timezone_offset));
        //d.setDate(d.getDate() + 1);

        var cycleData = [];
        var cycleObject = {};
        cycleObject.x = d.getTime();
        cycleObject.x2 = d.getTime();
        cycleObject.y = 0;
        cycleData.push(cycleObject);

        for (var i=0; i < device.cycles.length; i++) {

            var cycle = device.cycles[i];
            var cylcleTime = new Date(device.day);
            //d.setSeconds(d.getSeconds() + Math.abs(device.device_timezone_offset));

            cycleObject = {};
            cycleObject.x = cylcleTime.setSeconds(cylcleTime.getSeconds() + cycle.start);
            cycleObject.x2 = cylcleTime.setSeconds(cylcleTime.getSeconds() + cycle.duration);
            cycleObject.y = 0;

            if (cycle.type == 1) {
                cycleObject.color = '#f7a35c'
            }

            cycleData.push(cycleObject);
        }

        d = new Date(device.day);
        // d.setSeconds(d.getSeconds() + Math.abs(device.device_timezone_offset));
        d.setDate(d.getDate() + 1);
        cycleObject = {};
        cycleObject.x = d.getTime();
        cycleObject.x2 = d.getTime();
        cycleObject.y = 0;
        cycleData.push(cycleObject);

        var totalTimeRunning = number.format( (device.total_heating_time + device.total_cooling_time) / 60 / 60 , { places: 1 });
       
        Highcharts.chart('container2', {
            chart: {
                type: 'xrange'
            },
            title: {
                text: 'Cycles for ' + locale.format( d, {selector:"date", datePattern:"M/d/y" }) + ' (' + totalTimeRunning + ' hours)'
            },
            xAxis: {
                type: 'datetime'
            },
            yAxis: {
                title: {
                    text: ''
                },
                categories: ['Heat & Cool']
            },
            tooltip: {
                pointFormatter: function () {
                    return 'Duration: ' + number.format(((this.x2 - this.x) / 1000) / 60, { places: 1 }) + ' minutes';
                }
            },
            series: [{
                name: 'Time of Day',
                data: cycleData
            }]

        });

    }

    function queryData() {
        
        var deferred = new Deferred();

        if (dataDays.length > 0 
            && dataDays[0] == locale.format( startDate.get("value"), {selector:"date", datePattern:"M/d/y" } )
            && dataDays[dataDays.length - 1] == locale.format( endDate.get("value"), {selector:"date", datePattern:"M/d/y" } )) {

            deferred.resolve();
        }
        else { 
            domConstruct.empty(dom.byId("container2"));

            dom.byId('textarea').innerHTML = "";
            dom.byId('textarea').innerHTML += "Querying NEST.";

            var params = {
                TableName : tableName,
                KeyConditionExpression: "#d = :de and #da between :start_day and :end_day",
                ExpressionAttributeNames:{
                    "#da": "day",
                    "#d": "device"
                },
                ExpressionAttributeValues: {
                    ":start_day": locale.format( startDate.get("value"), {selector:"date", datePattern:"y-M-dd" } ),
                    ":end_day": locale.format( endDate.get("value"), {selector:"date", datePattern:"y-M-dd" } ),
                    ":de": deviceSelect.get("value")
                }
            };
            docClient.query(params, function(err, data) {
                
                if (err) {
                    dom.byId('textarea').innerHTML += "Unable to query. Error: " + "\n" + JSON.stringify(err, undefined, 2);
                    deferred.resolve();
                } else {

                    dataDays = [];
                    dataHeat = [];
                    dataCool = [];

                    deviceData = [];

                    var totalHeat = 0;
                    var totalCool = 0;

                    data.Items.forEach(function(device) {

                        var d = new Date(device.day);
                        d.setSeconds(d.getSeconds() + Math.abs(device.device_timezone_offset));
                        dataDays.push(locale.format( d, {selector:"date", datePattern:"M/d/y" }));
                        dataHeat.push(device.total_heating_time);
                        dataCool.push(device.total_cooling_time);

                        deviceData.push(device);

                        totalHeat += device.total_heating_time;
                        totalCool += device.total_cooling_time;

                        //document.getElementById('textarea').innerHTML += "\n" + device.day + ": " + device.total_heating_time + " " + device.total_cooling_time;
                    });

                    if (data.Items.length > 0) {
                        dom.byId('textarea').innerHTML = "Average Heat Run Time: " + number.format((totalHeat / data.Items.length) / 60 / 60 , { places: 1 }) + " hours<br />Average Cool Run Time: " + number.format((totalCool / data.Items.length) / 60 / 60 , { places: 1 }) + " hours";
                    }

                    deferred.resolve();
                    
                }
            });
        }
        return deferred.promise;
    }

    function getWeather() {

        var deferred = new Deferred();

        checkBox.set("disabled", true);

        tempMin = null;
        tempMax = null;
        if (checkBox.get('value')) {

            tempMin = {};
            tempMax = {};

            var url = 'https://www.ncdc.noaa.gov/cdo-web/api/v2/data?stationid=GHCND:USW00093812&datasetid=GHCND&datatypeid=TMIN&datatypeid=TMAX&units=standard&startdate=' + locale.format( startDate.get("value"), {selector:"date", datePattern:"y-M-dd" } ) + '&enddate=' + locale.format( endDate.get("value"), {selector:"date", datePattern:"y-M-dd" } ) + '&limit=1000';
            
            request.get(url, {
                headers: {
                    "X-Requested-With": null,
                    'Content-Type': 'text/plain',
                    'token': 'otsRTNjOxNAorrXrOteFpKuyVkzbdfMu'
                },
                //withCredentials: true,
                handleAs: 'json'
            }).then(function(data){
                
                var tempMinData = [];
                var tempMaxData = [];

                for (var i=0; i < data.results.length; i++) {

                    // {"date":"2017-12-20T00:00:00","datatype":"TMAX","station":"GHCND:USW00093812","attributes":",,W,","value":50.0}
                    var weatherData = data.results[i];

                    var weatherDay = locale.format(new Date(weatherData.date), {selector:"date", datePattern:"M/d/y" });

                    var dayIsFound = false;
                    for (var ii=0; ii < dataDays.length; ii++) {
                        if (weatherDay == dataDays[ii]) {
                            dayIsFound = true;
                            break;
                        }
                    }

                    if (dayIsFound) {

                        if (weatherData.datatype == 'TMIN') {
                            tempMinData.push(weatherData.value);
                        }
                        else if (weatherData.datatype == 'TMAX') {
                            tempMaxData.push(weatherData.value);
                        }

                    }
                    else {
                        if (new Date(weatherData.date) >= new Date(dataDays[0])) {
                            tempMinData.push(0);
                            tempMaxData.push(0);
                        }
                        
                    }

                }

                tempMin = {
                    type: 'spline',
                    yAxis: 1,
                    name: 'Minimum Tempature',
                    data: tempMinData,
                    color: '#0000ff'
                }

                tempMax = {
                    type: 'spline',
                    yAxis: 1,
                    name: 'Maximum Tempature',
                    data: tempMaxData,
                    color: '#ff0000'
                }

                checkBox.set("disabled", false);
                deferred.resolve();
            }, function(err){
                dom.byId('textarea').innerHTML = 'Error getting weather';
                checkBox.set("disabled", false);
                deferred.resolve();
            });
        }
        else {
            checkBox.set("disabled", false);
            deferred.resolve();
            
        }
        
        return deferred.promise;
    }

    buildMainChart();

});



</script>
</head>

<body class="nihilo" style="font-family: sans-serif">
        
    <div id="container" style="min-width: 310px; height: 400px; margin: 0 auto"></div>

    <div id="container2" style="min-width: 310px; height: 200px; margin: 0 auto"></div>

    <br>
    <div style="display: table;">
        <div style="display: table-row;">
            <div style="display: table-cell;padding: 5px;" ><b>Device:</b> </div><div style="display: table-cell;padding: 5px;" id="devices"></div>
        </div>
        <div style="display: table-row;">
            <div style="display: table-cell;padding: 5px;" ><b>Start Date: </b></div><div style="display: table-cell;padding: 5px;" id="startDate"></div>
        </div>
        <div style="display: table-row;">
            <div style="display: table-cell;padding: 5px;" ><b>End Date: </b></div><div style="display: table-cell;padding: 5px;" id="endDate"></div>
        </div>
    </div>
    <div style="padding: 5px;">
        <div><div id="showWeather" style="float: left;"></div> <b>Show Outside Tempature</b></div>
    </div>
    <div style="padding: 5px;" id= "textarea"></div>

</body>
</html>
